module ModuleRTP

  implicit none

  private
  public :: GetRunTimeParameters

contains

  !> Reads the run time parameters specified in the command line.
  subroutine GetRunTimeParameters( input_directory, output_directory, molecular_geometry_file, &
       n_times, t_min, t_max, FieldFile, Verbous, save_charge_migration_flag, &
       StepTime, StepWidth, ivorb, counted_number_of_orbitals)
    !
    use ModuleErrorHandling
    use ModuleCommandLineParameterList
    use ModuleString
    !
    implicit none
    !
    character(len=:), allocatable, intent(out) :: input_directory
    character(len=:), allocatable, intent(out) :: output_directory
    character(len=:), allocatable, intent(out) :: molecular_geometry_file
    integer                      , intent(out) :: n_times
    real(kind(1d0))              , intent(out) :: t_min
    real(kind(1d0))              , intent(out) :: t_max
    character(len=:), allocatable, intent(out) :: FieldFile
    logical                      , intent(out) :: Verbous
    logical                      , intent(out) :: save_charge_migration_flag
    real(kind(1d0))              , intent(out) :: StepTime
    real(kind(1d0))              , intent(out) :: StepWidth
    integer         , allocatable, intent(out) :: ivorb(:) 
    !
    character(len=*), parameter :: PROGRAM_DESCRIPTION=&
         "Computes the Charge Density on a spatial grid from "//&
         "tabulated orbitals, The Density Matrices and Transition Density Matrices"
    type( ClassCommandLineParameterList ) :: List
    character(len=512) :: strnBuf


    real(kind(1d0)) :: norm

    !CHARACTER(len=:),allocatable :: orbital_string
    CHARACTER(10000)  :: orbital_string
    integer, intent(out) :: counted_number_of_orbitals
!!$    character(10000) :: orbstring(10000)
    integer ::pos1, pos2 , i, number_of_orbitals

    call List%SetDescription(PROGRAM_DESCRIPTION)
    call List%Add( "--help" , "Print Command Usage" )
    call List%Add( "-i"     , "Input  Dir" ,"CD_inp", "optional" )
    call List%Add( "-o"     , "Output Dir" ,"CD_out", "optional" )
    call List%Add( "-xyz"   , "Mol Geom File in Inp Dir" ,"geom.xyz", "optional" )
    call List%Add( "-nt"    , "n times"    ,    101 , "optional" )
    call List%Add( "-t_min"  , "min time"   ,    0.d0, "optional" )
    call List%Add( "-t_max"  , "max time"   ,  200.d0, "optional" )
    call List%Add( "-field" , "Field File" ,"Field" , "optional" )
    call List%Add( "-v"     , "verbous"   )
    call List%Add( "-sden"  , "Save Charge Density to file (time consuming!)")
    call List%Add( "-stept" , "step time"   , 100.d0, "optional" )
    call List%Add( "-stepw" , "step width"  ,  10.d0, "optional" )
    call List%Add( "-iorb"  , "absolute index active orbitals ", "7,8,9,10,11,12,13", "optional" )
    call List%Add( "-xxx"   , "workaround")

    call List%Parse()

    if(List%Present("--help"))then
       call List%PrintUsage()
       stop
    end if

    call List%Get( "-o",  strnBuf  )
    allocate(output_directory,source=trim(adjustl(strnBuf)))
    call List%Get( "-i",  strnBuf  )
    allocate(input_directory,source=trim(adjustl(strnBuf)))
    call List%Get( "-xyz",  strnBuf  )
    allocate(molecular_geometry_file,source=input_directory//"/"//trim(adjustl(strnBuf)))
    call List%Get( "-nt",  n_times  )
    call List%Get( "-t_min", t_min  )
    call List%Get( "-t_max", t_max  )
    call List%Get( "-stept", StepTime  )
    call List%Get( "-stepw", StepWidth )
    Verbous = List%Present("-v")
    save_charge_migration_flag = List%Present("-sden")

    call List%Get( "-field",  strnBuf  )
    allocate(FieldFile,source=trim(adjustl(strnBuf)))

    pos1=1
    number_of_orbitals=0
    call List%Get( "-iorb", orbital_string)	
    counted_number_of_orbitals=1
    do 
       pos1=index(orbital_string,",")
       if(pos1<=0)exit
       counted_number_of_orbitals=counted_number_of_orbitals+1
       orbital_string(pos1:pos1)=" "
    enddo
    allocate(ivorb(counted_number_of_orbitals))
    read(orbital_string,*) (ivorb(i),i=1,counted_number_of_orbitals)
!!$    write(*,"(*(x,i4))") size(ivorb),ivorb 

    call List%Free()
    
    !
  end subroutine GetRunTimeParameters

 
end module ModuleRTP
















<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>densitypy.molcas.molcasscripts &mdash; DensityPy 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=92fd9be5" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=eafc0fe6" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js?v=f6245a2f"></script>
        <script src="../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            DensityPy
          </a>
              <div class="version">
                0.0.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../cli_run.html">cli_run</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../densitypy.Default_Settings.default_config.html">densitypy.Default_Settings.default_config</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../densitypy.autodocumentation_fortran.html">densitypy.autodocumentation_fortran</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../densitypy.autodocumentation_python.html">densitypy.autodocumentation_python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../densitypy.charge_migration.chargemigratonscripts.html">densitypy.charge_migration.chargemigratonscripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../densitypy.charge_migration.difference_dipole_charge.html">densitypy.charge_migration.difference_dipole_charge</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../densitypy.main.html">densitypy.main</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../densitypy.molcas.DipolesLogParser.html">densitypy.molcas.DipolesLogParser</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../densitypy.molcas.molcasscripts.html">densitypy.molcas.molcasscripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../densitypy.molcas.pegamoid.html">densitypy.molcas.pegamoid</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../densitypy.molcas.selectionofactivespace.html">densitypy.molcas.selectionofactivespace</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../densitypy.post_processing.chden_plotting_needs_work_to_update.plotdensity.html">densitypy.post_processing.chden_plotting_needs_work_to_update.plotdensity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../densitypy.post_processing.chden_plotting_needs_work_to_update.plottingscripts.html">densitypy.post_processing.chden_plotting_needs_work_to_update.plottingscripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../densitypy.post_processing.chden_plotting_needs_work_to_update.rpoints2vtk.html">densitypy.post_processing.chden_plotting_needs_work_to_update.rpoints2vtk</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../densitypy.post_processing.plotting_module.html">densitypy.post_processing.plotting_module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../densitypy.project_utils.command_execution.html">densitypy.project_utils.command_execution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../densitypy.project_utils.configuration_parser.html">densitypy.project_utils.configuration_parser</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../densitypy.project_utils.data_processing_utils.html">densitypy.project_utils.data_processing_utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../densitypy.project_utils.file_directory_ops.html">densitypy.project_utils.file_directory_ops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../densitypy.project_utils.file_parsing.html">densitypy.project_utils.file_parsing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../densitypy.project_utils.fortran_compilation_handler.html">densitypy.project_utils.fortran_compilation_handler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../densitypy.project_utils.logger.html">densitypy.project_utils.logger</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../densitypy.project_utils.string_dict_utils.html">densitypy.project_utils.string_dict_utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs.pythondocs.source.conf.html">docs.pythondocs.source.conf</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">DensityPy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">densitypy.molcas.molcasscripts</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for densitypy.molcas.molcasscripts</h1><div class="highlight"><pre>
<span></span><span class="ch">#! /usr/bin/env python3.10</span>
<span class="c1"># &gt;import molcasscripts as rmolcs</span>
<span class="c1"># TODO: use other available solutions to these problems when refactoring, preferably from the standard OpenMolcas</span>
<span class="c1">#  library</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">densitypy.project_utils.command_execution</span> <span class="kn">import</span> <span class="n">execute_command</span><span class="p">,</span> <span class="n">print_molcas_log_errors</span>
<span class="kn">from</span> <span class="nn">densitypy.project_utils.data_processing_utils</span> <span class="kn">import</span> <span class="n">extract_datasets_from_h5_to_csv</span>
<span class="kn">from</span> <span class="nn">densitypy.project_utils.file_directory_ops</span> <span class="kn">import</span> <span class="n">change_directory</span><span class="p">,</span> <span class="n">find</span>
<span class="kn">from</span> <span class="nn">densitypy.project_utils.logger</span> <span class="kn">import</span> <span class="n">setup_logger</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">setup_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">MOLECULAR_ORBITAL_DATA</span> <span class="o">=</span> <span class="p">{</span>  <span class="c1"># todo not used yet</span>
    <span class="s1">&#39;meta_info&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="c1"># Orbital sym=&#39;,i2,&#39; index=&#39;,i5,&#39; Energ=&#39;,F12.4,&#39; occ=&#39;,F4.2,&#39; type=&#39;,a1</span>
        <span class="s1">&#39;sys&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;energy&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;occ&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
    <span class="s1">&#39;density&#39;</span><span class="p">:</span> <span class="p">[]</span>
<span class="p">}</span>


<span class="c1"># Creates Helpful input file for Molcas with comments to help user begin (0)</span>
<div class="viewcode-block" id="create_help_input_file"><a class="viewcode-back" href="../../../densitypy.molcas.molcasscripts.html#densitypy.molcas.molcasscripts.create_help_input_file">[docs]</a><span class="k">def</span> <span class="nf">create_help_input_file</span><span class="p">():</span>
    <span class="c1"># &gt;Creates helpful input file guide for pymolcas</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;molcas_input_help.input&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
        <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&amp;GATEWAY&quot;</span>
                   <span class="s2">&quot; </span><span class="se">\n</span><span class="s2"> Title = NMA //  _name_of_project_&quot;</span>
                   <span class="s2">&quot; </span><span class="se">\n</span><span class="s2"> coord = NMA.xyz //  _geometry_file_&quot;</span>
                   <span class="s2">&quot; </span><span class="se">\n</span><span class="s2"> basis = 6-31+g_st__st_.1.molcas //  _name_of_basis_&quot;</span>
                   <span class="s2">&quot; </span><span class="se">\n</span><span class="s2"> group = c1 //this prevents use of symmetry&quot;</span>
                   <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&amp;SEWARD</span><span class="se">\n</span><span class="s2">&amp;SCF&quot;</span>
                   <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&amp;RASSCF&quot;</span>
                   <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Ras1   = 0 //  _number_of_RAS1_orbitals_&quot;</span>
                   <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Ras2   = 4 //  _number_of_RAS2_orbitals_&quot;</span>
                   <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> RAS3   = 0 //  _number_of_RAS3_orbitals_&quot;</span>
                   <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Inactive = 17 //  _number_of_Inactive_orbitals_&quot;</span>
                   <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> nactel   = 6 0 0 &quot;</span>
                   <span class="s2">&quot;//# of active electrons, allowed holes, allowed excitations.  _total_ _RAS1_ _RAS3_ &quot;</span>
                   <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> TDM       //writes DM and TDM to RASSCF.h5&quot;</span>
                   <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> CIRoot</span><span class="se">\n</span><span class="s2"> 4 4 1 &quot;</span>
                   <span class="s2">&quot;//e.g. 10 10 1 will do a state average calculation of the ground state &quot;</span>
                   <span class="s2">&quot;and the lower 4 excited states.  _highest_root_needed_ _dimention_of_CI_matrix_ _weight_&quot;</span>
                   <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&amp;RASSI&quot;</span>
                   <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Nr of JobIph&quot;</span>
                   <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> 1 ALL &quot;</span>
                   <span class="s2">&quot;    //e.g. # of job files, # of states in that file ==&gt;&gt; 1 10 or 1 ALL &quot;</span>
                   <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MEES //writes one-electron properties&quot;</span>
                   <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;molcas_input_help.input created&quot;</span><span class="p">)</span></div>


<span class="c1"># &gt;Makes points to be used for pymolcas input (0)</span>
<div class="viewcode-block" id="make_grid_coordinates"><a class="viewcode-back" href="../../../densitypy.molcas.molcasscripts.html#densitypy.molcas.molcasscripts.make_grid_coordinates">[docs]</a><span class="k">def</span> <span class="nf">make_grid_coordinates</span><span class="p">(</span><span class="n">molcas_directory</span><span class="p">,</span> <span class="n">Nx</span><span class="p">,</span> <span class="n">Ny</span><span class="p">,</span> <span class="n">Nz</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span><span class="p">):</span>
    <span class="c1"># &gt;Makes points to be used for pymolcas input</span>
    <span class="n">n_points</span> <span class="o">=</span> <span class="n">Nx</span> <span class="o">*</span> <span class="n">Ny</span> <span class="o">*</span> <span class="n">Nz</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Number of Points = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_points</span><span class="p">))</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">molcas_directory</span> <span class="o">+</span> <span class="s1">&#39;/gridcoord.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
        <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Nx</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">xmin</span> <span class="o">+</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Nx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">i</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Ny</span><span class="p">):</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">ymin</span> <span class="o">+</span> <span class="p">(</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Ny</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">j</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Ny</span><span class="p">):</span>
                    <span class="n">z</span> <span class="o">=</span> <span class="n">zmin</span> <span class="o">+</span> <span class="p">(</span><span class="n">zmax</span> <span class="o">-</span> <span class="n">zmin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">k</span>
                    <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">n_points</span></div>


<div class="viewcode-block" id="make_new_grid"><a class="viewcode-back" href="../../../densitypy.molcas.molcasscripts.html#densitypy.molcas.molcasscripts.make_new_grid">[docs]</a><span class="k">def</span> <span class="nf">make_new_grid</span><span class="p">(</span><span class="n">atomic_coordinates</span><span class="p">,</span> <span class="n">step_size</span><span class="p">,</span> <span class="n">boundary</span><span class="p">,</span> <span class="n">limitedgrid</span><span class="p">,</span> <span class="n">np</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># &gt; Define coordinates matrix</span>
    <span class="n">gridcoord</span> <span class="o">=</span> <span class="p">[]</span> <span class="o">*</span> <span class="mi">3</span>

    <span class="n">maxi</span><span class="p">,</span> <span class="n">mini</span> <span class="o">=</span> <span class="n">find_max_and_min</span><span class="p">(</span><span class="n">atomic_coordinates</span><span class="p">)</span>
    <span class="c1"># # &gt; Find Max Boundries of Grid</span>
    <span class="n">xmax</span> <span class="o">=</span> <span class="n">maxi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">boundary</span>
    <span class="n">ymax</span> <span class="o">=</span> <span class="n">maxi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">boundary</span>
    <span class="n">zmax</span> <span class="o">=</span> <span class="n">maxi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">boundary</span>
    <span class="n">xmin</span> <span class="o">=</span> <span class="n">mini</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">boundary</span>
    <span class="n">ymin</span> <span class="o">=</span> <span class="n">mini</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">boundary</span>
    <span class="n">zmin</span> <span class="o">=</span> <span class="n">mini</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">boundary</span>

    <span class="n">x_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">step_size</span><span class="p">)</span>
    <span class="n">y_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">step_size</span><span class="p">)</span>
    <span class="n">z_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span><span class="p">,</span> <span class="n">step_size</span><span class="p">)</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_</span><span class="p">,</span> <span class="n">y_</span><span class="p">,</span> <span class="n">z_</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>

    <span class="n">initial_Npoints</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">z_</span><span class="p">)</span>
    <span class="n">current_point_index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">z_</span><span class="p">)):</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                <span class="n">Z</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                <span class="n">r_point</span> <span class="o">=</span> <span class="p">[</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">]</span>
                <span class="n">current_point_index</span> <span class="o">=</span> <span class="n">current_point_index</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">percentage_done</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">current_point_index</span> <span class="o">/</span> <span class="n">initial_Npoints</span><span class="p">)),</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">percentage_done</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; %&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;  &#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">limitedgrid</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">icoord</span> <span class="ow">in</span> <span class="n">atomic_coordinates</span><span class="p">:</span>
                        <span class="n">avec_new</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">avec_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">icoord</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                        <span class="n">avec_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">icoord</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                        <span class="n">avec_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">icoord</span><span class="p">[</span><span class="mi">2</span><span class="p">])[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

                        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">distance</span><span class="p">(</span><span class="n">avec_new</span><span class="p">,</span> <span class="n">r_point</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="n">boundary</span><span class="p">:</span>
                            <span class="n">gridcoord</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">])</span>
                            <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">gridcoord</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">])</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Done Making Grid&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">gridcoord</span><span class="p">,</span> <span class="n">initial_Npoints</span></div>


<div class="viewcode-block" id="make_better_grid"><a class="viewcode-back" href="../../../densitypy.molcas.molcasscripts.html#densitypy.molcas.molcasscripts.make_better_grid">[docs]</a><span class="k">def</span> <span class="nf">make_better_grid</span><span class="p">(</span><span class="n">molcas_directory</span><span class="p">,</span> <span class="n">geometry_path</span><span class="p">,</span> <span class="n">step_size</span><span class="p">,</span> <span class="n">Boundary</span><span class="p">,</span> <span class="n">limitedgrid</span><span class="p">,</span> <span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Making Grid&quot;</span><span class="p">)</span>
    <span class="n">atomic_coordinates</span> <span class="o">=</span> <span class="n">read_xyz</span><span class="p">(</span><span class="n">geometry_path</span><span class="p">,</span> <span class="n">return_coordinates_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># &gt; Make_Grid(maxi, mini, Npoints)</span>
    <span class="n">gridcoord</span><span class="p">,</span> <span class="n">initial_Npoints</span> <span class="o">=</span> <span class="n">make_new_grid</span><span class="p">(</span><span class="n">atomic_coordinates</span><span class="p">,</span> <span class="n">step_size</span><span class="p">,</span> <span class="n">Boundary</span><span class="p">,</span> <span class="n">limitedgrid</span><span class="p">)</span>
    <span class="n">n_points</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gridcoord</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Number of Points = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_points</span><span class="p">))</span>
    <span class="c1"># &gt; Writes to file</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing Grid to File&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">molcas_directory</span> <span class="o">+</span> <span class="s1">&#39;/gridcoord.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
        <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_points</span><span class="p">):</span>
            <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">gridcoord</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">gridcoord</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">gridcoord</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="mi">2</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">n_points</span></div>


<div class="viewcode-block" id="add_grid_it_to_manual_input_file"><a class="viewcode-back" href="../../../densitypy.molcas.molcasscripts.html#densitypy.molcas.molcasscripts.add_grid_it_to_manual_input_file">[docs]</a><span class="k">def</span> <span class="nf">add_grid_it_to_manual_input_file</span><span class="p">(</span><span class="n">pymolcas_input</span><span class="p">,</span> <span class="n">project_name</span><span class="p">,</span> <span class="n">molcas_directory</span><span class="p">,</span> <span class="n">orbital_list</span><span class="p">,</span> <span class="n">n_points</span><span class="p">):</span>
    <span class="n">Lowest_orbital</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">orbital_list</span><span class="p">)</span>
    <span class="n">Highest_orbital</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">orbital_list</span><span class="p">)</span>

    <span class="c1"># Construct the output file path</span>
    <span class="n">output_file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">molcas_directory</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s1">.input&#39;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">molcas_directory</span> <span class="o">+</span> <span class="s1">&#39;/gridcoord.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fin</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file_path</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
        <span class="c1"># Using csv.reader to read the CSV file</span>
        <span class="n">csv_reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">fin</span><span class="p">)</span>

        <span class="c1"># Skip the first row (header)</span>
        <span class="nb">next</span><span class="p">(</span><span class="n">csv_reader</span><span class="p">)</span>

        <span class="c1"># Log the information</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Adding Grid_it to </span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s1">.input&#39;</span><span class="p">)</span>

        <span class="c1"># Writing the initial part of the output</span>
        <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&amp;GRIDIT &#39;</span>
                   <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> select &#39;</span>
                   <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> 1:</span><span class="si">{</span><span class="n">Lowest_orbital</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">Highest_orbital</span><span class="si">}</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> NOLUSCUS &#39;</span>
                   <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> GRID&#39;</span>
                   <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> &#39;</span><span class="p">)</span>
        <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">n_points</span><span class="p">))</span>
        <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Writing each row of the CSV to the output file</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">csv_reader</span><span class="p">:</span>
            <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="read_xyz"><a class="viewcode-back" href="../../../densitypy.molcas.molcasscripts.html#densitypy.molcas.molcasscripts.read_xyz">[docs]</a><span class="k">def</span> <span class="nf">read_xyz</span><span class="p">(</span><span class="n">xyz_file</span><span class="p">,</span> <span class="n">return_coordinates_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">atoms</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">z</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">atomic_coordinates</span> <span class="o">=</span> <span class="p">[]</span> <span class="o">*</span> <span class="mi">3</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">xyz_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fin</span><span class="p">:</span>
        <span class="n">n_atoms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fin</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">fin</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fin</span><span class="p">:</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">atom_</span><span class="p">,</span> <span class="n">x_</span><span class="p">,</span> <span class="n">y_</span><span class="p">,</span> <span class="n">z_</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">atoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom_</span><span class="p">)</span>
            <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x_</span><span class="p">))</span>
            <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">y_</span><span class="p">))</span>
            <span class="n">z</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">z_</span><span class="p">))</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">stop</span> <span class="o">==</span> <span class="n">n_atoms</span><span class="p">):</span>
                <span class="k">break</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">)):</span>
        <span class="n">atomic_coordinates</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;filename:         </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">xyz_file</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;title:            </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">title</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;number of atoms:  </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">n_atoms</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;atoms:            </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">atoms</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_coordinates_only</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">atomic_coordinates</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># return n_atoms, title, atoms, atomic_coordinates</span>

        <span class="c1"># Combine atom sand atomic_coordinates into a dictionary since they are in the same order</span>
        <span class="n">returning_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">)):</span>
            <span class="c1"># In case the atom name has already been used lets number them</span>
            <span class="k">if</span> <span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">returning_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">number_of_times_atom_has_been_used</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">returning_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">key</span><span class="p">])</span>
                <span class="n">returning_dict</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">number_of_times_atom_has_been_used</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atomic_coordinates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">returning_dict</span><span class="p">[</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">atomic_coordinates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;n_atoms&#39;</span><span class="p">:</span> <span class="n">n_atoms</span><span class="p">,</span>
            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
            <span class="s1">&#39;atoms&#39;</span><span class="p">:</span> <span class="n">returning_dict</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="distance"><a class="viewcode-back" href="../../../densitypy.molcas.molcasscripts.html#densitypy.molcas.molcasscripts.distance">[docs]</a><span class="k">def</span> <span class="nf">distance</span><span class="p">(</span><span class="n">avec</span><span class="p">,</span> <span class="n">bvec</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">avec</span><span class="p">,</span> <span class="n">bvec</span><span class="p">))</span>
    <span class="n">cvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">cvec</span></div>


<div class="viewcode-block" id="find_max_and_min"><a class="viewcode-back" href="../../../densitypy.molcas.molcasscripts.html#densitypy.molcas.molcasscripts.find_max_and_min">[docs]</a><span class="k">def</span> <span class="nf">find_max_and_min</span><span class="p">(</span><span class="n">coords</span><span class="p">):</span>
    <span class="n">maxi</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">mini</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">iPol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
        <span class="nb">max</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)):</span>
            <span class="n">max_</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">iPol</span><span class="p">])[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">max_</span> <span class="o">&gt;</span> <span class="nb">max</span><span class="p">:</span>
                <span class="nb">max</span> <span class="o">=</span> <span class="n">max_</span>
        <span class="nb">min</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)):</span>
            <span class="n">min_</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">iPol</span><span class="p">])[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">min_</span> <span class="o">&lt;</span> <span class="nb">min</span><span class="p">:</span>
                <span class="nb">min</span> <span class="o">=</span> <span class="n">min_</span>
        <span class="n">maxi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">)</span>
        <span class="n">mini</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">min</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">maxi</span><span class="p">,</span> <span class="n">mini</span></div>


<span class="c1">#################################################################################################</span>
<span class="c1"># Creates input from users own input file for pymolcas(0)</span>
<div class="viewcode-block" id="copy_and_prepare_molcas_input_file_for_run"><a class="viewcode-back" href="../../../densitypy.molcas.molcasscripts.html#densitypy.molcas.molcasscripts.copy_and_prepare_molcas_input_file_for_run">[docs]</a><span class="k">def</span> <span class="nf">copy_and_prepare_molcas_input_file_for_run</span><span class="p">(</span><span class="n">pymolcas_input</span><span class="p">,</span> <span class="n">project_name</span><span class="p">,</span> <span class="n">molcas_directory</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Uses the user&#39;s input file to create a molcas input file by copying the user&#39;s input file and then</span>
<span class="sd">    utilizing it to add other necessary sections to the input file.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">KEYWORDS_NEEDED</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;TDM&quot;</span><span class="p">:</span> <span class="s1">&#39;Transition Density Matrix&#39;</span><span class="p">,</span>
        <span class="s2">&quot;RASSCF&quot;</span><span class="p">:</span> <span class="s1">&#39;Density Matrix&#39;</span><span class="p">,</span>
        <span class="s2">&quot;RASSI&quot;</span><span class="p">:</span> <span class="s1">&#39;Density Matrix&#39;</span>
    <span class="p">}</span>

    <span class="n">keywords_needed_found</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Create input from user&#39;s own input file for pymolcas</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pymolcas_input</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fin</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">molcas_directory</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s1">.input&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Creating </span><span class="si">{</span><span class="n">molcas_directory</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s1">.input from </span><span class="si">{</span><span class="n">pymolcas_input</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fin</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;//&#39;</span><span class="p">):</span>
                <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">string</span> <span class="ow">in</span> <span class="n">KEYWORDS_NEEDED</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">string</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
                        <span class="n">keywords_needed_found</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>

    <span class="c1"># Validate input file</span>
    <span class="c1"># TODO: Implement the validation logic</span>
    <span class="k">for</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">matrix</span> <span class="ow">in</span> <span class="n">KEYWORDS_NEEDED</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">keyword</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keywords_needed_found</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">keyword</span><span class="si">}</span><span class="s1"> keyword was not found in Molcas input file. As a result, no </span><span class="si">{</span><span class="n">matrix</span><span class="si">}</span><span class="s1"> will be created and &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;ChargeMigration modules will not be able to run.&#39;</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="n">keywords_needed_found</span></div>


<span class="c1"># &gt;Calls pymolcas and writes to scrach folder and log file(1)</span>
<div class="viewcode-block" id="call_open_molcas"><a class="viewcode-back" href="../../../densitypy.molcas.molcasscripts.html#densitypy.molcas.molcasscripts.call_open_molcas">[docs]</a><span class="k">def</span> <span class="nf">call_open_molcas</span><span class="p">(</span><span class="n">project_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">molcas_directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="c1"># &gt;Calls pymolcas and writes to scratch folder and log file</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running OpenMolcas&quot;</span><span class="p">)</span>

    <span class="c1"># Use the context manager to temporarily change the working directory</span>
    <span class="k">with</span> <span class="n">change_directory</span><span class="p">(</span><span class="n">molcas_directory</span><span class="p">):</span>
        <span class="c1"># make sure file exists</span>
        <span class="k">assert</span> <span class="n">find</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s1">.input&#39;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">molcas_directory</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s1">.input not found in </span><span class="si">{</span><span class="n">molcas_directory</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_logger</span> <span class="o">=</span> <span class="n">setup_logger</span><span class="p">(</span><span class="s1">&#39;open_molcas&#39;</span><span class="p">)</span>
            <span class="n">execute_command</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;pymolcas </span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s1">.input -f&#39;</span><span class="p">,</span> <span class="n">_logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Error in call_open_molcas&#39;</span><span class="p">)</span>
            <span class="n">print_molcas_log_errors</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s1">.log&#39;</span><span class="p">,</span> <span class="s2">&quot;Timing&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Done Running OpenMolcas&quot;</span><span class="p">)</span></div>


<span class="c1"># &gt;Extract Density Matrix, Transition Density Matrix, ENERGIES, AO_Dipoles, MO_energies, MO_vectors(1,1,2)</span>


<span class="c1"># &gt;Extract Density Matrix, Transition Density Matrix, ENERGIES, AO_Dipoles, MO_energies, MO_vectors(1,1,2)</span>
<div class="viewcode-block" id="load_project_rasscf_h5_file"><a class="viewcode-back" href="../../../densitypy.molcas.molcasscripts.html#densitypy.molcas.molcasscripts.load_project_rasscf_h5_file">[docs]</a><span class="k">def</span> <span class="nf">load_project_rasscf_h5_file</span><span class="p">(</span><span class="n">project_name</span><span class="p">,</span> <span class="n">molcas_output_directory</span><span class="p">,</span> <span class="n">workingdirectory</span><span class="p">):</span>
    <span class="c1"># &gt;Extract Density Matrix, Transition Density Matrix, ENERGIES, AO_Dipoles, MO_energies, MO_vectors</span>
    <span class="n">DATASETS_TO_EXTRACT</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;DENSITY_MATRIX&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;TRANSITION_DENSITY_MATRIX&quot;</span><span class="p">,</span> <span class="s2">&quot;ROOT_ENERGIES&quot;</span><span class="p">,</span> <span class="s2">&quot;AO_MLTPL_X&quot;</span><span class="p">,</span> <span class="s2">&quot;AO_MLTPL_Y&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;AO_MLTPL_Z&quot;</span><span class="p">,</span> <span class="s2">&quot;MO_ENERGIES&quot;</span><span class="p">,</span> <span class="s2">&quot;MO_VECTORS&quot;</span><span class="p">]</span>

    <span class="c1"># The keys are the names of the datasets to extract and the values are used for the output files</span>
    <span class="n">dataset_mappings</span> <span class="o">=</span> <span class="p">{</span><span class="n">dataset</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">molcas_output_directory</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">dataset</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">DATASETS_TO_EXTRACT</span><span class="p">}</span>

    <span class="c1"># &gt;Find &lt;ProjectName&gt;.rasscf.h5</span>
    <span class="n">rasscf_h5_dirpath</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s1">.rasscf.h5&#39;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">workingdirectory</span><span class="p">)</span>
    <span class="n">extract_datasets_from_h5_to_csv</span><span class="p">(</span>
        <span class="n">h5_filepath</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">rasscf_h5_dirpath</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s1">.rasscf.h5&#39;</span><span class="p">,</span>
        <span class="c1"># &gt;Define the dataset mappings using DATASETS_TO_EXTRACT as keys and molcas_output_directory/dataset names as</span>
        <span class="c1"># values</span>
        <span class="n">dataset_mapping</span><span class="o">=</span><span class="n">dataset_mappings</span>
    <span class="p">)</span></div>


<span class="c1"># &gt;Extracts Density for the grids of each Orbital found oin &lt;Project&gt;.grid (0)</span>
<div class="viewcode-block" id="parse_project_grid_file"><a class="viewcode-back" href="../../../densitypy.molcas.molcasscripts.html#densitypy.molcas.molcasscripts.parse_project_grid_file">[docs]</a><span class="k">def</span> <span class="nf">parse_project_grid_file</span><span class="p">(</span><span class="n">output_filename</span><span class="p">,</span> <span class="n">directorypath</span><span class="p">):</span>
    <span class="n">gridfilepath</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span><span class="n">output_filename</span> <span class="o">+</span> <span class="s1">&#39;.grid&#39;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">directorypath</span><span class="p">)</span>

    <span class="c1"># Open the file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">gridfilepath</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">output_filename</span> <span class="o">+</span> <span class="s1">&#39;.grid&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Natom&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;atoms&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;meta_info&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;N_of_MO&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;N_of_Grids&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;N_of_Points&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;Block_Size&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;N_Blocks&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;Is_cutoff&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;CutOff&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;N_P&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;N_INDEX&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s1">&#39;molecular_orbitals&#39;</span><span class="p">:</span> <span class="p">{}</span>
    <span class="p">}</span>

    <span class="n">atom_flag</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">store_the_index_of_the_line</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">line_index</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>  <span class="c1"># from line 0 to line N_lines</span>

        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Natom=&#39;</span><span class="p">):</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Natom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="n">atom_flag</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">atom_flag</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;atoms&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Natom&#39;</span><span class="p">]:</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">atom_info</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;element&#39;</span><span class="p">:</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
                <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                <span class="s1">&#39;z&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="p">}</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;atoms&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom_info</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;VERSION=&#39;</span><span class="p">):</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;meta_info&#39;</span><span class="p">][</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;N_of_MO=&#39;</span><span class="p">):</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;meta_info&#39;</span><span class="p">][</span><span class="s1">&#39;N_of_MO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;N_of_Grids=&#39;</span><span class="p">):</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;meta_info&#39;</span><span class="p">][</span><span class="s1">&#39;N_of_Grids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;N_of_Points=&#39;</span><span class="p">):</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;meta_info&#39;</span><span class="p">][</span><span class="s1">&#39;N_of_Points&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Block_Size=&#39;</span><span class="p">):</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;meta_info&#39;</span><span class="p">][</span><span class="s1">&#39;Block_Size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;N_Blocks=&#39;</span><span class="p">):</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;meta_info&#39;</span><span class="p">][</span><span class="s1">&#39;N_Blocks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Is_cutoff=&#39;</span><span class="p">):</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;meta_info&#39;</span><span class="p">][</span><span class="s1">&#39;Is_cutoff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;CutOff=&#39;</span><span class="p">):</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;meta_info&#39;</span><span class="p">][</span><span class="s1">&#39;CutOff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;N_P=&#39;</span><span class="p">):</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;meta_info&#39;</span><span class="p">][</span><span class="s1">&#39;N_P&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;N_INDEX=&#39;</span><span class="p">):</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;meta_info&#39;</span><span class="p">][</span><span class="s1">&#39;N_INDEX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;GridName=&#39;</span><span class="p">):</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;GridName=\s*(\d+)\s*(\d+)\s*([\-\d\.]+)\s*\(([\d\.]+)\)\s*(\d)&quot;</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                <span class="c1"># Orbital sym=&#39;,i2,&#39; index=&#39;,i5,&#39; Energ=&#39;,F12.4,&#39; occ=&#39;,F4.2,&#39; type=&#39;,a1</span>
                <span class="n">orbital_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                <span class="n">orbital_info</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;sym&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span>
                    <span class="s1">&#39;energy&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)),</span>
                    <span class="s1">&#39;occ&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">)),</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
                <span class="p">}</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;molecular_orbitals&#39;</span><span class="p">][</span><span class="n">orbital_index</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;meta_info&#39;</span><span class="p">:</span> <span class="n">orbital_info</span><span class="p">,</span>
                    <span class="s1">&#39;density&#39;</span><span class="p">:</span> <span class="p">[]</span>
                <span class="p">}</span>
                <span class="k">continue</span>

        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Title=&#39;</span><span class="p">):</span>  <span class="c1"># break and continue lines from here</span>
            <span class="n">store_the_index_of_the_line</span> <span class="o">=</span> <span class="n">line_index</span>
            <span class="k">break</span>

    <span class="k">assert</span> <span class="n">store_the_index_of_the_line</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Could not find Title=&lt;MOj&gt; in the grid file&quot;</span>
    <span class="n">density_containing_lines</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">store_the_index_of_the_line</span><span class="p">:]</span>
    <span class="n">actual_n_chunks</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;meta_info&#39;</span><span class="p">][</span><span class="s1">&#39;N_Blocks&#39;</span><span class="p">]</span>
    <span class="n">orbitals_to_extract</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;molecular_orbitals&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">*</span> <span class="n">actual_n_chunks</span>
    <span class="n">orbital_index</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">line_index</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">density_containing_lines</span><span class="p">):</span>  <span class="c1"># use re for matching</span>

        <span class="c1"># e.g. Title=   18  or Title= 1 or Title=    194 etc...</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;Title=\s*(\d+)&#39;</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>

            <span class="n">orbital_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">orbital_index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">orbitals_to_extract</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">orbital_index</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">orbitals_to_extract</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">continue</span>
            <span class="c1"># data[&#39;molecular_orbitals&#39;][orbital_index][&#39;density&#39;].append(float(0))  # fixme appending is expensive</span>

            <span class="k">assert</span> <span class="p">(</span><span class="n">orbital_index</span> <span class="ow">in</span> <span class="n">orbitals_to_extract</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Orbital </span><span class="si">{</span><span class="n">orbital_index</span><span class="si">}</span><span class="s2"> not found in orbitals_to_extract&quot;</span>
            <span class="c1"># pop the orbital from the list</span>
            <span class="n">orbitals_to_extract</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">orbitals_to_extract</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">orbital_index</span><span class="p">))</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">orbital_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;molecular_orbitals&#39;</span><span class="p">][</span><span class="n">orbital_index</span><span class="p">][</span><span class="s1">&#39;density&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>  <span class="c1"># fixme appending is expensive</span>

    <span class="c1"># print(json.dumps(data, indent=4))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;Successfully Extracted Density Grids for each of the orbitals&quot;</span><span class="p">)</span>  <span class="c1"># todo perhaps... add a check to see if all grids were extracted</span>

    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="write_grid_density_file"><a class="viewcode-back" href="../../../densitypy.molcas.molcasscripts.html#densitypy.molcas.molcasscripts.write_grid_density_file">[docs]</a><span class="k">def</span> <span class="nf">write_grid_density_file</span><span class="p">(</span><span class="n">grid_file_data_dict</span><span class="p">,</span> <span class="n">molcas_output_directory</span><span class="p">):</span>  <span class="c1"># todo pythonic data model</span>
    <span class="c1"># A Dataframe [N_Orbitals x N_Points]</span>
    <span class="n">grids_meta_info</span> <span class="o">=</span> <span class="n">grid_file_data_dict</span><span class="p">[</span><span class="s1">&#39;meta_info&#39;</span><span class="p">]</span>
    <span class="n">molecular_orbitals_data</span> <span class="o">=</span> <span class="n">grid_file_data_dict</span><span class="p">[</span><span class="s1">&#39;molecular_orbitals&#39;</span><span class="p">]</span>

    <span class="c1"># Prepare dataframe</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">molecular_orbitals_data</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                      <span class="c1"># index=range(grids_meta_info[&#39;N_of_Points&#39;])</span>
                      <span class="p">)</span>
    <span class="k">for</span> <span class="n">orbital_index</span><span class="p">,</span> <span class="n">orbital_data</span> <span class="ow">in</span> <span class="n">molecular_orbitals_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">df</span><span class="p">[</span><span class="n">orbital_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">orbital_data</span><span class="p">[</span><span class="s1">&#39;density&#39;</span><span class="p">]</span>

    <span class="c1"># Make sure total number of indexes is the same as the number of points</span>
    <span class="c1"># assert len(df) == grids_meta_info[&#39;N_of_Points&#39;]</span>

    <span class="c1"># Write to file</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">molcas_output_directory</span><span class="si">}</span><span class="s1">/grid_density.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Ruben Fernandez Carbon.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>
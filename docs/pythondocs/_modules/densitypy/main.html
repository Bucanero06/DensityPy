<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>main &mdash; DensityPy 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=92fd9be5" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=eafc0fe6" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=f6245a2f"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            DensityPy
          </a>
              <div class="version">
                0.0.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../cli_run.html">cli_run</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Default_Settings.default_config.html">Default_Settings.default_config</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../autodocumentation_fortran.html">autodocumentation_fortran</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../autodocumentation_python.html">autodocumentation_python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../charge_migration.chargemigratonscripts.html">charge_migration.chargemigratonscripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../charge_migration.difference_dipole_charge.html">charge_migration.difference_dipole_charge</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../main.html">main</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../molcas.DipolesLogParser.html">molcas.DipolesLogParser</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../molcas.molcasscripts.html">molcas.molcasscripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../molcas.pegamoid.html">molcas.pegamoid</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../molcas.selectionofactivespace.html">molcas.selectionofactivespace</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../post_processing.chden_plotting_needs_work_to_update.plotdensity.html">post_processing.chden_plotting_needs_work_to_update.plotdensity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../post_processing.chden_plotting_needs_work_to_update.plottingscripts.html">post_processing.chden_plotting_needs_work_to_update.plottingscripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../post_processing.chden_plotting_needs_work_to_update.rpoints2vtk.html">post_processing.chden_plotting_needs_work_to_update.rpoints2vtk</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../post_processing.plotting_module.html">post_processing.plotting_module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project_utils.command_execution.html">project_utils.command_execution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project_utils.configuration_parser.html">project_utils.configuration_parser</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project_utils.data_processing_utils.html">project_utils.data_processing_utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project_utils.file_directory_ops.html">project_utils.file_directory_ops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project_utils.file_parsing.html">project_utils.file_parsing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project_utils.fortran_compilation_handler.html">project_utils.fortran_compilation_handler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project_utils.logger.html">project_utils.logger</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project_utils.string_dict_utils.html">project_utils.string_dict_utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs.pythondocs.source.conf.html">docs.pythondocs.source.conf</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">DensityPy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">main</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for main</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3.10</span>
<span class="c1"># Made by Ruben</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span><span class="p">,</span> <span class="n">system</span>

<span class="kn">from</span> <span class="nn">Default_Settings.default_config</span> <span class="kn">import</span> <span class="n">DEFAULT_BIN_FILE_PATH</span>
<span class="kn">from</span> <span class="nn">charge_migration.chargemigratonscripts</span> <span class="kn">import</span> <span class="n">Write_FieldHelp</span><span class="p">,</span> <span class="n">Write_Pulses</span><span class="p">,</span> <span class="n">Call_Charge_Migration</span><span class="p">,</span> \
    <span class="n">Call_Charge_MigrationFT</span><span class="p">,</span> <span class="n">Call_Spectrum_Reconstruction_n_Difference</span><span class="p">,</span> <span class="n">generate_time_delays</span>
<span class="kn">from</span> <span class="nn">molcas.DipolesLogParser</span> <span class="kn">import</span> <span class="n">DipolesLogParser</span>
<span class="kn">from</span> <span class="nn">molcas.molcasscripts</span> <span class="kn">import</span> <span class="n">create_help_input_file</span><span class="p">,</span> <span class="n">copy_and_prepare_molcas_input_file_for_run</span><span class="p">,</span> \
    <span class="n">make_better_grid</span><span class="p">,</span> \
    <span class="n">make_grid_coordinates</span><span class="p">,</span> <span class="n">add_grid_it_to_manual_input_file</span><span class="p">,</span> <span class="n">call_open_molcas</span><span class="p">,</span> <span class="n">parse_project_grid_file</span><span class="p">,</span> \
    <span class="n">load_project_rasscf_h5_file</span><span class="p">,</span> <span class="n">write_grid_density_file</span>
<span class="kn">from</span> <span class="nn">molcas.selectionofactivespace</span> <span class="kn">import</span> <span class="n">deprecated_SelectionOfActiveSpace</span><span class="p">,</span> <span class="n">SelectionOfActiveSpace</span>
<span class="kn">from</span> <span class="nn">post_processing.plotting_module</span> <span class="kn">import</span> <span class="n">plot_dipole_correlation_maps</span><span class="p">,</span> <span class="n">plot_cm_correlation_maps</span>
<span class="kn">from</span> <span class="nn">project_utils.configuration_parser</span> <span class="kn">import</span> <span class="n">parse_configuration_file</span>
<span class="kn">from</span> <span class="nn">project_utils.file_directory_ops</span> <span class="kn">import</span> <span class="n">change_directory_manager</span><span class="p">,</span> <span class="n">make_directory</span><span class="p">,</span> <span class="n">copy_to</span><span class="p">,</span> \
    <span class="n">file_lenth</span><span class="p">,</span> <span class="n">find</span>
<span class="kn">from</span> <span class="nn">project_utils.logger</span> <span class="kn">import</span> <span class="n">setup_logger</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">setup_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>


<div class="viewcode-block" id="run_densitypy"><a class="viewcode-back" href="../../main.html#main.run_densitypy">[docs]</a><span class="k">def</span> <span class="nf">run_densitypy</span><span class="p">(</span><span class="n">study_directory</span><span class="p">,</span> <span class="n">json_config_path</span><span class="p">,</span> <span class="n">molcas_input</span><span class="p">,</span>
                  <span class="n">run_charge_migration</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">run_charge_migration_ft</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">run_spectrum_reconstruction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">field_file_help</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">molcas_input_help</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">scforbs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">gridit</span><span class="p">:</span> <span class="nb">bool</span> <span class="ow">or</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">autocas</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">write_charge_migration</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">debug_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">justh5</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">justgetdipoles</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">justgetdensity</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">weights_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">givenfieldfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">make_fortran</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">make_fortran_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># todo usage to be changed, here for testing</span>
                  <span class="n">tidy_up_experiment_dir</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">compress_study_directory</span><span class="o">=</span><span class="kc">False</span>
                  <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Entry Way to DensityPy. This function facilitates computational chemistry simulations with OpenMolcas and the ASTRA-ChargeMigration Fortran code.</span>

<span class="sd">    Functionality and Scope:</span>
<span class="sd">        Molcas Integration: Incorporates Molcas for quantum chemical calculations, essential for accurate modeling of electronic structures.</span>
<span class="sd">        Charge Migration Analysis: Executes both standard and Fourier-transformed charge migration simulations, offering deep insights into molecular dynamics.</span>
<span class="sd">        Data Visualization and Analysis: Provides tools for generating plots and graphs, crucial for interpreting complex simulation data.</span>
<span class="sd">        Configurable Workflow: Leverages a JSON-based configuration system, allowing for flexible and detailed setup of simulation parameters.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        json_config_path: String, path to the JSON configuration file.</span>
<span class="sd">        study_directory: String, directory path for output and intermediate files.</span>
<span class="sd">        molcas_input: String, optional path to the Molcas input file.</span>
<span class="sd">        Additional flags and options to control specific features and modes of operation.</span>

<span class="sd">    Usage:</span>
<span class="sd">        run_densitypy(</span>
<span class="sd">              json_config_path=&quot;xy_polarized_config.json&quot;,</span>
<span class="sd">              study_directory=&quot;Studies/ExampleStudy&quot;,</span>
<span class="sd">              molcas_input=&#39;molcas_input_help.input&#39;,</span>
<span class="sd">              run_charge_migration=True,</span>
<span class="sd">              run_charge_migration_ft=True,</span>
<span class="sd">              run_spectrum_reconstruction=True,</span>
<span class="sd">              plot=True,</span>
<span class="sd">              field_file_help=False, molcas_input_help=False,</span>
<span class="sd">              scforbs=False, gridit=True, write_charge_migration=None, debug_mode=False,</span>
<span class="sd">              justh5=False, justgetdipoles=False, justgetdensity=False, weights_file=None, givenfieldfile=None,</span>
<span class="sd">              make_fortran=False, make_fortran_config={&#39;directory&#39;: &#39;/home/ruben/PycharmProjects/DensityPy/densityfort&#39;,&#39;make_flags&#39;: &#39;all DEB_FLAG=d&#39;})</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">make_fortran</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">project_utils.fortran_compilation_handler</span> <span class="kn">import</span> <span class="n">compile_ifort_fortran_code</span>
        <span class="n">return_code</span><span class="p">,</span> <span class="n">compiler_output_df</span> <span class="o">=</span> <span class="n">compile_ifort_fortran_code</span><span class="p">(</span><span class="o">**</span><span class="n">make_fortran_config</span><span class="p">)</span>

        <span class="c1"># todo either way should postprocess output for better user experience</span>
        <span class="k">if</span> <span class="n">return_code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">compiler_output_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Compilation failed with return code </span><span class="si">{</span><span class="n">return_code</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="c1"># compiler_output_df = compiler_output_df.sort_values(by=&#39;Type&#39;,</span>
                <span class="c1">#                                                     key=lambda x: x.map(DEFAULT_LOGGIN_VALUES))</span>
                <span class="c1"># logger.(f&#39;\n{compiler_output_df}&#39;)</span>
            <span class="n">exit</span><span class="p">(</span><span class="n">return_code</span><span class="p">)</span>

    <span class="c1"># TODO too explicit, does not allow for new args to be added easily</span>
    <span class="n">COMMAND_ARGS</span> <span class="o">=</span> <span class="p">[</span><span class="n">molcas_input</span><span class="p">,</span> <span class="n">scforbs</span><span class="p">,</span> <span class="n">run_charge_migration</span><span class="p">,</span> <span class="n">run_charge_migration_ft</span><span class="p">,</span>
                    <span class="n">molcas_input_help</span><span class="p">,</span> <span class="n">justh5</span><span class="p">,</span> <span class="n">justgetdensity</span><span class="p">,</span> <span class="n">justgetdipoles</span><span class="p">,</span> <span class="n">field_file_help</span><span class="p">,</span>
                    <span class="n">run_spectrum_reconstruction</span><span class="p">,</span> <span class="n">plot</span><span class="p">,</span> <span class="n">tidy_up_experiment_dir</span><span class="p">,</span> <span class="n">compress_study_directory</span><span class="p">]</span>

    <span class="n">study_directory</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">study_directory</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">))</span>

    <span class="c1"># Change directory to study_directory and back to original directory when done or if crashes</span>
    <span class="k">with</span> <span class="n">change_directory_manager</span><span class="p">(</span><span class="n">study_directory</span><span class="p">):</span>
        <span class="c1"># Load Values # todo fixup the json_config and runnable command behavior, is ugly</span>
        <span class="n">json_config</span> <span class="o">=</span> <span class="n">parse_configuration_file</span><span class="p">(</span>
            <span class="n">json_config_path</span><span class="p">)</span>  <span class="c1"># If not passed or does not exist will write example file</span>
        <span class="n">runnable_command_available_bool</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">COMMAND_ARGS</span><span class="p">)</span> <span class="k">else</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">json_config</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">runnable_command_available_bool</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Found </span><span class="si">{</span><span class="n">json_config_path</span><span class="si">}</span><span class="s1"> but nothing was ran. No command line action arguments used. Use -h for help.&#39;</span><span class="p">)</span>

        <span class="c1"># Determine if Help Inputs are Needed</span>
        <span class="n">need_molcas_input</span> <span class="o">=</span> <span class="n">molcas_input_help</span> <span class="ow">or</span> <span class="p">(</span><span class="n">molcas_input</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">molcas_input</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">need_molcas_input</span><span class="p">:</span>
            <span class="n">create_help_input_file</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">field_file_help</span><span class="p">:</span>
            <span class="n">Write_FieldHelp</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">need_molcas_input</span> <span class="ow">or</span> <span class="n">field_file_help</span><span class="p">:</span>
            <span class="n">exit</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">autocas</span><span class="p">:</span>
            <span class="n">occupation</span><span class="p">,</span> <span class="n">orbitals</span><span class="p">,</span> <span class="n">energy</span> <span class="o">=</span> <span class="n">SelectionOfActiveSpace</span><span class="p">(</span>
                <span class="n">xyz_file</span><span class="o">=</span><span class="n">json_config</span><span class="p">[</span><span class="s1">&#39;projectsettings&#39;</span><span class="p">][</span><span class="s1">&#39;xyzmoleculegeometry&#39;</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;n2 </span><span class="se">\n</span><span class="s2">cas: </span><span class="si">{</span><span class="n">occupation</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">orbs: </span><span class="si">{</span><span class="n">orbitals</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">energy: </span><span class="si">{</span><span class="n">energy</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># TODO</span>
            <span class="n">exit</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">scforbs</span><span class="p">:</span>
            <span class="c1"># Selection of Active Space using scforbs argument.</span>
            <span class="n">deprecated_SelectionOfActiveSpace</span><span class="p">(</span><span class="n">json_config</span><span class="p">)</span>

        <span class="c1"># Split JSON config into sections</span>
        <span class="n">project_settings</span> <span class="o">=</span> <span class="n">json_config</span><span class="p">[</span><span class="s1">&#39;projectsettings&#39;</span><span class="p">]</span>
        <span class="n">grid_settings</span> <span class="o">=</span> <span class="n">json_config</span><span class="p">[</span><span class="s1">&#39;gridsettings&#39;</span><span class="p">]</span>
        <span class="n">charge_migration_settings</span> <span class="o">=</span> <span class="n">json_config</span><span class="p">[</span><span class="s1">&#39;chargemigrationsettings&#39;</span><span class="p">]</span>
        <span class="n">pump_settings</span> <span class="o">=</span> <span class="n">json_config</span><span class="p">[</span><span class="s1">&#39;pumppulsessettings&#39;</span><span class="p">]</span>
        <span class="n">probe_settings</span> <span class="o">=</span> <span class="n">json_config</span><span class="p">[</span><span class="s1">&#39;probepulsessettings&#39;</span><span class="p">]</span>
        <span class="n">charge_migration_ft_settings</span> <span class="o">=</span> <span class="n">json_config</span><span class="p">[</span><span class="s1">&#39;chargemigrationftsettings&#39;</span><span class="p">]</span>

        <span class="c1"># Project Settings</span>
        <span class="n">project_name</span> <span class="o">=</span> <span class="n">project_settings</span><span class="p">[</span><span class="s1">&#39;projectname&#39;</span><span class="p">]</span>
        <span class="n">xyz_geometry_path</span> <span class="o">=</span> <span class="n">project_settings</span><span class="p">[</span><span class="s1">&#39;xyzmoleculegeometry&#39;</span><span class="p">]</span>
        <span class="n">number_of_states</span> <span class="o">=</span> <span class="n">project_settings</span><span class="p">[</span><span class="s1">&#39;numberofstates&#39;</span><span class="p">]</span>
        <span class="n">list_of_orbitals</span> <span class="o">=</span> <span class="n">project_settings</span><span class="p">[</span><span class="s1">&#39;listofactiveorbitals&#39;</span><span class="p">]</span>
        <span class="n">molcas_output_directory</span> <span class="o">=</span> <span class="n">project_settings</span><span class="p">[</span><span class="s1">&#39;molcasoutputdirectory&#39;</span><span class="p">]</span>
        <span class="n">experiment_directory</span> <span class="o">=</span> <span class="n">project_settings</span><span class="p">[</span><span class="s1">&#39;experimentdirectory&#39;</span><span class="p">]</span>

        <span class="c1"># Grid Settings</span>
        <span class="n">nx</span> <span class="o">=</span> <span class="n">grid_settings</span><span class="p">[</span><span class="s1">&#39;numberofpointsxaxis&#39;</span><span class="p">]</span>
        <span class="n">ny</span> <span class="o">=</span> <span class="n">grid_settings</span><span class="p">[</span><span class="s1">&#39;numberofpointsyaxis&#39;</span><span class="p">]</span>
        <span class="n">nz</span> <span class="o">=</span> <span class="n">grid_settings</span><span class="p">[</span><span class="s1">&#39;numberofpointszaxis&#39;</span><span class="p">]</span>
        <span class="n">xmin</span> <span class="o">=</span> <span class="n">grid_settings</span><span class="p">[</span><span class="s1">&#39;xmin&#39;</span><span class="p">]</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="n">grid_settings</span><span class="p">[</span><span class="s1">&#39;xmax&#39;</span><span class="p">]</span>
        <span class="n">ymin</span> <span class="o">=</span> <span class="n">grid_settings</span><span class="p">[</span><span class="s1">&#39;ymin&#39;</span><span class="p">]</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="n">grid_settings</span><span class="p">[</span><span class="s1">&#39;ymax&#39;</span><span class="p">]</span>
        <span class="n">zmin</span> <span class="o">=</span> <span class="n">grid_settings</span><span class="p">[</span><span class="s1">&#39;zmin&#39;</span><span class="p">]</span>
        <span class="n">zmax</span> <span class="o">=</span> <span class="n">grid_settings</span><span class="p">[</span><span class="s1">&#39;zmax&#39;</span><span class="p">]</span>
        <span class="n">step_size</span> <span class="o">=</span> <span class="n">grid_settings</span><span class="p">[</span><span class="s1">&#39;stepsize&#39;</span><span class="p">]</span>
        <span class="n">boundary</span> <span class="o">=</span> <span class="n">grid_settings</span><span class="p">[</span><span class="s1">&#39;boundary&#39;</span><span class="p">]</span>

        <span class="c1"># Charge Migration Parameters</span>
        <span class="n">field_file</span> <span class="o">=</span> <span class="n">charge_migration_settings</span><span class="p">[</span><span class="s1">&#39;fieldfile&#39;</span><span class="p">]</span>
        <span class="n">number_of_times</span> <span class="o">=</span> <span class="n">charge_migration_settings</span><span class="p">[</span><span class="s1">&#39;numberoftimes&#39;</span><span class="p">]</span>  <span class="c1"># fixme error indexing &gt;= 10000, probably datatype</span>
        <span class="n">min_time</span> <span class="o">=</span> <span class="n">charge_migration_settings</span><span class="p">[</span><span class="s1">&#39;mintime&#39;</span><span class="p">]</span>
        <span class="n">max_time</span> <span class="o">=</span> <span class="n">charge_migration_settings</span><span class="p">[</span><span class="s1">&#39;maxtime&#39;</span><span class="p">]</span>
        <span class="n">bath_temperature</span> <span class="o">=</span> <span class="n">charge_migration_settings</span><span class="p">[</span><span class="s1">&#39;bathtemperature&#39;</span><span class="p">]</span>
        <span class="n">dephasing_factor</span> <span class="o">=</span> <span class="n">charge_migration_settings</span><span class="p">[</span><span class="s1">&#39;dephasingfactor&#39;</span><span class="p">]</span>
        <span class="n">relaxation_factor</span> <span class="o">=</span> <span class="n">charge_migration_settings</span><span class="p">[</span><span class="s1">&#39;relaxationfactor&#39;</span><span class="p">]</span>

        <span class="c1"># Pump Settings</span>
        <span class="n">type_of_pulse_pump</span> <span class="o">=</span> <span class="n">pump_settings</span><span class="p">[</span><span class="s1">&#39;typeofpulse&#39;</span><span class="p">]</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">pump_settings</span><span class="p">[</span><span class="s1">&#39;starttime&#39;</span><span class="p">]</span>
        <span class="n">pump_central_frequency</span> <span class="o">=</span> <span class="n">pump_settings</span><span class="p">[</span><span class="s1">&#39;pumpcentralfrequency&#39;</span><span class="p">]</span>
        <span class="n">pump_periods</span> <span class="o">=</span> <span class="n">pump_settings</span><span class="p">[</span><span class="s1">&#39;pumpperiods&#39;</span><span class="p">]</span>
        <span class="n">pump_phase</span> <span class="o">=</span> <span class="n">pump_settings</span><span class="p">[</span><span class="s1">&#39;pumpphase&#39;</span><span class="p">]</span>
        <span class="n">pump_intensity</span> <span class="o">=</span> <span class="n">pump_settings</span><span class="p">[</span><span class="s1">&#39;pumpintensity&#39;</span><span class="p">]</span>
        <span class="n">pump_polarization</span> <span class="o">=</span> <span class="n">pump_settings</span><span class="p">[</span><span class="s1">&#39;pumppolarization&#39;</span><span class="p">]</span>

        <span class="c1"># Probe Settings</span>
        <span class="n">type_of_pulse_probe</span> <span class="o">=</span> <span class="n">probe_settings</span><span class="p">[</span><span class="s1">&#39;typeofpulse&#39;</span><span class="p">]</span>
        <span class="n">time_delay_start</span> <span class="o">=</span> <span class="n">probe_settings</span><span class="p">[</span><span class="s1">&#39;timedelaystart&#39;</span><span class="p">]</span>
        <span class="n">time_delay_stop</span> <span class="o">=</span> <span class="n">probe_settings</span><span class="p">[</span><span class="s1">&#39;timedelaystop&#39;</span><span class="p">]</span>
        <span class="n">number_of_pp</span> <span class="o">=</span> <span class="n">probe_settings</span><span class="p">[</span><span class="s1">&#39;numberofpp&#39;</span><span class="p">]</span>
        <span class="n">time_Delay_weight_factor</span> <span class="o">=</span> <span class="n">probe_settings</span><span class="p">[</span><span class="s1">&#39;timedelayweightfactor&#39;</span><span class="p">]</span>
        <span class="n">probe_central_frequency</span> <span class="o">=</span> <span class="n">probe_settings</span><span class="p">[</span><span class="s1">&#39;probecentralfrequency&#39;</span><span class="p">]</span>
        <span class="n">probe_periods</span> <span class="o">=</span> <span class="n">probe_settings</span><span class="p">[</span><span class="s1">&#39;probeperiods&#39;</span><span class="p">]</span>
        <span class="n">probe_phase</span> <span class="o">=</span> <span class="n">probe_settings</span><span class="p">[</span><span class="s1">&#39;probephase&#39;</span><span class="p">]</span>
        <span class="n">probe_intensity</span> <span class="o">=</span> <span class="n">probe_settings</span><span class="p">[</span><span class="s1">&#39;probeintensity&#39;</span><span class="p">]</span>
        <span class="n">probe_polarization</span> <span class="o">=</span> <span class="n">probe_settings</span><span class="p">[</span><span class="s1">&#39;probepolarization&#39;</span><span class="p">]</span>

        <span class="c1"># Charge Migration FT Parameters</span>
        <span class="n">number_of_omegas</span> <span class="o">=</span> <span class="n">charge_migration_ft_settings</span><span class="p">[</span><span class="s1">&#39;numberofomegas&#39;</span><span class="p">]</span>
        <span class="n">min_omegas</span> <span class="o">=</span> <span class="n">charge_migration_ft_settings</span><span class="p">[</span><span class="s1">&#39;minomega&#39;</span><span class="p">]</span>
        <span class="n">max_omegas</span> <span class="o">=</span> <span class="n">charge_migration_ft_settings</span><span class="p">[</span><span class="s1">&#39;maxomega&#39;</span><span class="p">]</span>
        <span class="n">number_of_tau_omegas</span> <span class="o">=</span> <span class="n">charge_migration_ft_settings</span><span class="p">[</span><span class="s1">&#39;numberoftauomegas&#39;</span><span class="p">]</span>
        <span class="n">min_tau_omega</span> <span class="o">=</span> <span class="n">charge_migration_ft_settings</span><span class="p">[</span><span class="s1">&#39;mintauomega&#39;</span><span class="p">]</span>
        <span class="n">max_tau_omega</span> <span class="o">=</span> <span class="n">charge_migration_ft_settings</span><span class="p">[</span><span class="s1">&#39;maxtauomega&#39;</span><span class="p">]</span>
        <span class="n">ft_time_step</span> <span class="o">=</span> <span class="n">charge_migration_ft_settings</span><span class="p">[</span><span class="s1">&#39;fttimestep&#39;</span><span class="p">]</span>
        <span class="n">ft_width_step</span> <span class="o">=</span> <span class="n">charge_migration_ft_settings</span><span class="p">[</span><span class="s1">&#39;ftwidthstep&#39;</span><span class="p">]</span>
        <span class="n">Volume</span> <span class="o">=</span> <span class="n">step_size</span> <span class="o">*</span> <span class="n">step_size</span> <span class="o">*</span> <span class="n">step_size</span>

        <span class="n">time_delay_range</span> <span class="o">=</span> <span class="n">generate_time_delays</span><span class="p">(</span><span class="n">number_of_pp</span><span class="p">,</span> <span class="n">time_delay_start</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">time_delay_stop</span><span class="p">,</span>
                                                <span class="n">time_Delay_weight_factor</span><span class="p">)</span>

        <span class="c1"># Useful Flags for e.g. debugging</span>
        <span class="k">if</span> <span class="n">justh5</span><span class="p">:</span>
            <span class="n">load_project_rasscf_h5_file</span><span class="p">(</span><span class="n">project_name</span><span class="p">,</span> <span class="n">molcas_output_directory</span><span class="p">,</span> <span class="n">molcas_output_directory</span><span class="p">)</span>
            <span class="n">exit</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">justgetdensity</span><span class="p">:</span>
            <span class="n">grid_file_data_dict</span> <span class="o">=</span> <span class="n">parse_project_grid_file</span><span class="p">(</span><span class="n">project_name</span><span class="p">,</span> <span class="n">molcas_output_directory</span><span class="p">)</span>
            <span class="n">write_grid_density_file</span><span class="p">(</span><span class="n">grid_file_data_dict</span><span class="p">,</span> <span class="n">molcas_output_directory</span><span class="p">)</span>
            <span class="n">exit</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">justgetdipoles</span><span class="p">:</span>
            <span class="n">project</span> <span class="o">=</span> <span class="n">DipolesLogParser</span><span class="p">(</span><span class="n">log_path</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">molcas_output_directory</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s1">.log&#39;</span><span class="p">)</span>
            <span class="n">project</span><span class="o">.</span><span class="n">write_csvs</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="n">molcas_output_directory</span><span class="p">)</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">get_mu_heatmaps</span><span class="p">()</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">molcas_output_directory</span><span class="si">}</span><span class="s1">/dipole-heatmap.png&#39;</span><span class="p">)</span>
            <span class="n">exit</span><span class="p">()</span>

        <span class="c1"># &gt;OpenMolcas</span>
        <span class="k">if</span> <span class="n">molcas_input</span><span class="p">:</span>

            <span class="n">n_points</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># Prepare Input</span>
            <span class="n">make_directory</span><span class="p">(</span><span class="n">molcas_output_directory</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="c1"># Copies input file and returns keywords in input file #todo should actually parse input , use pymolcas</span>
            <span class="n">keywords_needed_found</span> <span class="o">=</span> <span class="n">copy_and_prepare_molcas_input_file_for_run</span><span class="p">(</span><span class="n">pymolcas_input</span><span class="o">=</span><span class="n">molcas_input</span><span class="p">,</span>
                                                                               <span class="n">project_name</span><span class="o">=</span><span class="n">project_name</span><span class="p">,</span>
                                                                               <span class="n">molcas_directory</span><span class="o">=</span><span class="n">molcas_output_directory</span><span class="p">)</span>

            <span class="n">copy_to</span><span class="p">(</span><span class="n">xyz_geometry_path</span><span class="p">,</span> <span class="n">molcas_output_directory</span><span class="p">)</span>

            <span class="c1"># gridit can be fixme deprecated until updated to use new grid algorithm</span>
            <span class="c1">#   True = use gridit on molcas with with uniform grid points</span>
            <span class="c1">#   False = Do not use or create any grid or add gridit to input file</span>
            <span class="c1">#   &#39;smart&#39; =  Use our smart grid algorithm to create a grid based on the molecule and step size</span>
            <span class="c1">#   &#39;limited&#39; = Use our truncated grid algorithm to create a grid based on the molecule and config settings</span>
            <span class="c1">#   &#39;manual&#39; = Use a grid file to create a grid, this is the only option that requires a grid file to be specified in the config file</span>
            <span class="k">if</span> <span class="n">gridit</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;smart&#39;</span><span class="p">,</span> <span class="s1">&#39;limited&#39;</span><span class="p">]:</span>
                <span class="n">limitedgrid</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">gridit</span> <span class="o">==</span> <span class="s1">&#39;limited&#39;</span> <span class="k">else</span> <span class="kc">False</span>
                <span class="n">n_points</span> <span class="o">=</span> <span class="n">make_better_grid</span><span class="p">(</span><span class="n">molcas_output_directory</span><span class="p">,</span> <span class="n">xyz_geometry_path</span><span class="p">,</span> <span class="n">step_size</span><span class="p">,</span> <span class="n">boundary</span><span class="p">,</span>
                                            <span class="n">limitedgrid</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">gridit</span> <span class="o">==</span> <span class="s1">&#39;manual&#39;</span><span class="p">:</span>
                <span class="n">gridfile</span> <span class="o">=</span> <span class="n">json_config</span><span class="p">[</span><span class="s1">&#39;grid_settings&#39;</span><span class="p">][</span><span class="s1">&#39;default_grid_file&#39;</span><span class="p">]</span>
                <span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cp </span><span class="si">{</span><span class="n">gridfile</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">molcas_output_directory</span><span class="si">}</span><span class="s2">/gridcoord&quot;</span><span class="p">)</span>
                <span class="n">n_points</span> <span class="o">=</span> <span class="n">file_lenth</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">molcas_output_directory</span><span class="si">}</span><span class="s1">/gridcoord&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of Points = </span><span class="si">{</span><span class="n">n_points</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">gridit</span><span class="p">:</span>
                <span class="n">n_points</span> <span class="o">=</span> <span class="n">make_grid_coordinates</span><span class="p">(</span><span class="n">molcas_output_directory</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">zmin</span><span class="p">,</span>
                                                 <span class="n">zmax</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">gridit</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;gridit is </span><span class="si">{</span><span class="n">gridit</span><span class="si">}</span><span class="s2"> but should be False, True, &#39;smart&#39;, &#39;limited&#39;, or &#39;manual&#39;&quot;</span>

            <span class="k">if</span> <span class="n">gridit</span><span class="p">:</span>
                <span class="n">add_grid_it_to_manual_input_file</span><span class="p">(</span><span class="n">molcas_input</span><span class="p">,</span> <span class="n">project_name</span><span class="p">,</span> <span class="n">molcas_output_directory</span><span class="p">,</span> <span class="n">list_of_orbitals</span><span class="p">,</span>
                                                 <span class="n">n_points</span><span class="p">)</span>
            <span class="c1"># &gt;Run Open Molcas</span>
            <span class="n">call_open_molcas</span><span class="p">(</span><span class="n">project_name</span><span class="p">,</span> <span class="n">molcas_output_directory</span><span class="p">)</span>
            <span class="c1"># Extract Data Required for Charge Migration</span>
            <span class="n">copy_to</span><span class="p">(</span><span class="n">molcas_input</span><span class="p">,</span> <span class="n">molcas_output_directory</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">logfilepath</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span><span class="n">project_name</span> <span class="o">+</span> <span class="s2">&quot;.log&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">molcas_output_directory</span><span class="p">)</span>
            <span class="n">copy_to</span><span class="p">(</span><span class="n">logfilepath</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">project_name</span> <span class="o">+</span> <span class="s2">&quot;.log &quot;</span><span class="p">,</span> <span class="n">molcas_output_directory</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">copy_to</span><span class="p">(</span><span class="n">xyz_geometry_path</span><span class="p">,</span> <span class="n">molcas_output_directory</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;RASSI&quot;</span> <span class="ow">in</span> <span class="n">keywords_needed_found</span><span class="p">:</span>  <span class="c1"># todo add to documentation that dipoles are only parsed for RASSI</span>
                <span class="n">project</span> <span class="o">=</span> <span class="n">DipolesLogParser</span><span class="p">(</span><span class="n">log_path</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">molcas_output_directory</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s1">.log&#39;</span><span class="p">)</span>
                <span class="n">project</span><span class="o">.</span><span class="n">write_csvs</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="n">molcas_output_directory</span><span class="p">)</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">get_mu_heatmaps</span><span class="p">()</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">molcas_output_directory</span><span class="si">}</span><span class="s1">/dipole-heatmap.png&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">gridit</span><span class="p">:</span>
                <span class="n">grid_file_data_dict</span> <span class="o">=</span> <span class="n">parse_project_grid_file</span><span class="p">(</span><span class="n">project_name</span><span class="p">,</span> <span class="n">molcas_output_directory</span><span class="p">)</span>
                <span class="n">write_grid_density_file</span><span class="p">(</span><span class="n">grid_file_data_dict</span><span class="p">,</span> <span class="n">molcas_output_directory</span><span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;RASSCF&quot;</span> <span class="ow">in</span> <span class="n">keywords_needed_found</span><span class="p">:</span>
                <span class="n">load_project_rasscf_h5_file</span><span class="p">(</span><span class="n">project_name</span><span class="p">,</span> <span class="n">molcas_output_directory</span><span class="p">,</span> <span class="n">molcas_output_directory</span><span class="p">)</span>

        <span class="c1"># &gt;ChargeMigration TODO(Subject to Change based on C_i reconstruction implementation)</span>
        <span class="k">if</span> <span class="n">run_charge_migration</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">molcas_output_directory</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find </span><span class="si">{</span><span class="n">molcas_output_directory</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">exit</span><span class="p">()</span>
            <span class="n">make_directory</span><span class="p">(</span><span class="n">experiment_directory</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">givenfieldfile</span><span class="p">:</span>
                <span class="n">Write_Pulses</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">experiment_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">field_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">type_of_pulse_pump</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span>
                             <span class="n">pump_central_frequency</span><span class="p">,</span>
                             <span class="n">pump_periods</span><span class="p">,</span> <span class="n">pump_phase</span><span class="p">,</span> <span class="n">pump_intensity</span><span class="p">,</span> <span class="n">pump_polarization</span><span class="p">,</span>
                             <span class="n">type_of_pulse_probe</span><span class="p">,</span> <span class="n">time_delay_range</span><span class="p">,</span> <span class="n">probe_central_frequency</span><span class="p">,</span>
                             <span class="n">probe_periods</span><span class="p">,</span> <span class="n">probe_phase</span><span class="p">,</span> <span class="n">probe_intensity</span><span class="p">,</span> <span class="n">probe_polarization</span><span class="p">,</span> <span class="n">write_charge_migration</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">field_file</span> <span class="o">=</span> <span class="n">givenfieldfile</span>
            <span class="c1"># Run Charge Migration TODO(Subject to Change based on C_i reconstruction implementation)</span>
            <span class="n">Call_Charge_Migration</span><span class="p">(</span><span class="n">DEFAULT_BIN_FILE_PATH</span><span class="p">,</span> <span class="n">molcas_output_directory</span><span class="p">,</span> <span class="n">experiment_directory</span><span class="p">,</span> <span class="n">number_of_times</span><span class="p">,</span>
                                  <span class="n">min_time</span><span class="p">,</span> <span class="n">max_time</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">experiment_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">field_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ft_time_step</span><span class="p">,</span>
                                  <span class="n">ft_width_step</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">molcas_output_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">xyz_geometry_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">list_of_orbitals</span><span class="p">,</span>
                                  <span class="n">write_charge_migration</span><span class="p">,</span> <span class="n">Volume</span><span class="p">,</span> <span class="n">debug_mode</span><span class="p">,</span> <span class="n">weights_file</span><span class="p">,</span> <span class="n">dephasing_factor</span><span class="p">,</span>
                                  <span class="n">relaxation_factor</span><span class="p">,</span> <span class="n">bath_temperature</span><span class="p">)</span>

            <span class="c1"># copy_file_to(json_config_path, f&quot;{experiment_directory}/{json_config_path.replace(&#39;.json&#39;, &#39;_used.txt&#39;)}&quot;)</span>

        <span class="c1"># &gt;ChargeMigrationFT</span>
        <span class="k">if</span> <span class="n">run_charge_migration_ft</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">givenfieldfile</span><span class="p">:</span>
                <span class="c1"># Make Field File</span>
                <span class="n">Write_Pulses</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">experiment_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">field_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">type_of_pulse_pump</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span>
                             <span class="n">pump_central_frequency</span><span class="p">,</span>
                             <span class="n">pump_periods</span><span class="p">,</span> <span class="n">pump_phase</span><span class="p">,</span> <span class="n">pump_intensity</span><span class="p">,</span> <span class="n">pump_polarization</span><span class="p">,</span>
                             <span class="n">type_of_pulse_probe</span><span class="p">,</span> <span class="n">time_delay_range</span><span class="p">,</span> <span class="n">probe_central_frequency</span><span class="p">,</span>
                             <span class="n">probe_periods</span><span class="p">,</span> <span class="n">probe_phase</span><span class="p">,</span> <span class="n">probe_intensity</span><span class="p">,</span> <span class="n">probe_polarization</span><span class="p">,</span> <span class="n">write_charge_migration</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">field_file</span> <span class="o">=</span> <span class="n">givenfieldfile</span>
            <span class="c1"># Run Charge Migration FT</span>
            <span class="n">Call_Charge_MigrationFT</span><span class="p">(</span><span class="n">DEFAULT_BIN_FILE_PATH</span><span class="p">,</span> <span class="n">molcas_output_directory</span><span class="p">,</span> <span class="n">experiment_directory</span><span class="p">,</span>
                                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">molcas_output_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">xyz_geometry_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                    <span class="n">number_of_omegas</span><span class="p">,</span>
                                    <span class="n">min_omegas</span><span class="p">,</span> <span class="n">max_omegas</span><span class="p">,</span> <span class="n">number_of_tau_omegas</span><span class="p">,</span> <span class="n">min_tau_omega</span><span class="p">,</span> <span class="n">max_tau_omega</span><span class="p">,</span>
                                    <span class="n">ft_time_step</span><span class="p">,</span> <span class="n">ft_width_step</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">experiment_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">field_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                    <span class="n">debug_mode</span><span class="p">)</span>
        <span class="c1"># &gt;SpectrumReconstruction</span>
        <span class="k">if</span> <span class="n">run_spectrum_reconstruction</span><span class="p">:</span>
            <span class="n">Call_Spectrum_Reconstruction_n_Difference</span><span class="p">(</span><span class="n">DEFAULT_BIN_FILE_PATH</span><span class="p">,</span> <span class="n">molcas_output_directory</span><span class="p">,</span>
                                                      <span class="n">experiment_directory</span><span class="p">,</span>
                                                      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">molcas_output_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">xyz_geometry_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                                      <span class="n">number_of_omegas</span><span class="p">,</span>
                                                      <span class="n">min_omegas</span><span class="p">,</span> <span class="n">max_omegas</span><span class="p">,</span>
                                                      <span class="n">number_of_tau_omegas</span><span class="p">,</span> <span class="n">min_tau_omega</span><span class="p">,</span> <span class="n">max_tau_omega</span><span class="p">,</span> <span class="n">debug_mode</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="c1"># Becke Weights</span>
            <span class="c1"># plot_becke_weights(study_directory, experiment_directory, xyz_geometry_path, weights_file)</span>

            <span class="c1"># Lets plot the Pulses</span>
            <span class="c1"># plot_pulses(study_directory, experiment_directory, time_delay_range, min_time, max_time, plot_all=False)</span>
            <span class="c1"># plot_ft_pulses(study_directory, experiment_directory, time_delay_range, plot_all=False)</span>
            <span class="c1">#</span>
            <span class="c1"># # Lets plot the Dipolar Reponse vs Time (t)</span>
            <span class="c1"># plot_dipoles_v_time(study_directory, experiment_directory, time_delay_range, min_time, max_time,</span>
            <span class="c1">#                     plot_all=False)</span>
            <span class="c1"># plot_atomic_dipoles_v_time(study_directory, experiment_directory, time_delay_range, min_time, max_time,</span>
            <span class="c1">#                            xyz_geometry_path, plot_all=False)</span>
            <span class="c1"># # difference_between_dipole_and_atomic_charges_v_time(study_directory, experiment_directory, time_delay_range,</span>
            <span class="c1"># #                                                     min_time, max_time, xyz_geometry_path)</span>
            <span class="c1">#</span>
            <span class="c1"># # Lets plot the Dipolar Reponse vs Time (t) in the Frequency Domain (w)</span>
            <span class="c1"># plot_ft_all_dipoles_v_time(study_directory, experiment_directory, dephasing_factor, relaxation_factor,</span>
            <span class="c1">#                            pump_settings, probe_settings, charge_migration_ft_settings,</span>
            <span class="c1">#                            try_color_maps=False)</span>
            <span class="c1"># plot_ft_all_atomic_dipoles_v_time(study_directory, experiment_directory, dephasing_factor,</span>
            <span class="c1">#                                   relaxation_factor,</span>
            <span class="c1">#                                   pump_settings, probe_settings, charge_migration_ft_settings,</span>
            <span class="c1">#                                   xyz_geometry_path, try_color_maps=False)</span>

            <span class="c1"># Lets plot the 2D Spectrum</span>
            <span class="c1"># plot_2d_spectrum(study_directory, experiment_directory, dephasing_factor, relaxation_factor,</span>
            <span class="c1">#                  pump_settings, probe_settings, charge_migration_ft_settings, match_scales=False)</span>
            <span class="c1"># plot_2d_spectrum_peak_analysis(study_directory, experiment_directory)</span>

            <span class="c1"># Correlation Plots</span>
            <span class="c1"># plot_dipole_correlation_maps(study_directory, experiment_directory)</span>
            <span class="n">plot_cm_correlation_maps</span><span class="p">(</span><span class="n">study_directory</span><span class="p">,</span> <span class="n">experiment_directory</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">compress_study_directory</span><span class="p">:</span>
        <span class="c1"># Compress the study directory</span>
        <span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tar -czvf </span><span class="si">{</span><span class="n">study_directory</span><span class="si">}</span><span class="s2">.tar.gz </span><span class="si">{</span><span class="n">study_directory</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rm -rf </span><span class="si">{</span><span class="n">study_directory</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Compressed </span><span class="si">{</span><span class="n">study_directory</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">study_directory</span><span class="si">}</span><span class="s2">.tar.gz&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">tidy_up_experiment_dir</span><span class="p">:</span>
        <span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rm </span><span class="si">{</span><span class="n">study_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">experiment_directory</span><span class="si">}</span><span class="s2">/AtomicCharge/AtomicChargeFTPP*&quot;</span><span class="p">)</span>
        <span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rm </span><span class="si">{</span><span class="n">study_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">experiment_directory</span><span class="si">}</span><span class="s2">/AtomicCharge/AtomicChargePP*&quot;</span><span class="p">)</span>
        <span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rm </span><span class="si">{</span><span class="n">study_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">experiment_directory</span><span class="si">}</span><span class="s2">/Dipole/DipolePP*&quot;</span><span class="p">)</span>
        <span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rm </span><span class="si">{</span><span class="n">study_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">experiment_directory</span><span class="si">}</span><span class="s2">/Dipole/DipoleFTPP*&quot;</span><span class="p">)</span>
        <span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rm -r </span><span class="si">{</span><span class="n">study_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">experiment_directory</span><span class="si">}</span><span class="s2">/Pulses&quot;</span><span class="p">)</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">make_fortran_config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="s1">&#39;/home/ruben/PycharmProjects/DensityPy/densityfort&#39;</span><span class="p">,</span>
                               <span class="n">make_flags</span><span class="o">=</span><span class="s1">&#39;all DEB_FLAG=d&#39;</span><span class="p">,</span>
                               <span class="c1"># ... other settings but this is mvp</span>
                               <span class="p">)</span>

    <span class="n">run_densitypy</span><span class="p">(</span>
        <span class="n">study_directory</span><span class="o">=</span><span class="s2">&quot;/home/ruben/PycharmProjects/DensityPy/Studies/ExampleStudy&quot;</span><span class="p">,</span>
        <span class="c1"># json_config_path=&quot;nma_configuration.json&quot;,</span>
        <span class="n">json_config_path</span><span class="o">=</span><span class="s2">&quot;cm_plot_configuration.json&quot;</span><span class="p">,</span>
        <span class="n">molcas_input</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># &#39;molcas_input_help.input&#39;, # False just means not running molcas</span>
        <span class="n">run_charge_migration</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">run_charge_migration_ft</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">run_spectrum_reconstruction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="c1">#</span>
        <span class="n">field_file_help</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">molcas_input_help</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">gridit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">write_charge_migration</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">debug_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">justh5</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">justgetdipoles</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">justgetdensity</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">weights_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">givenfieldfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">tidy_up_experiment_dir</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">compress_study_directory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">make_fortran</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">make_fortran_config</span><span class="o">=</span><span class="n">make_fortran_config</span>
    <span class="p">)</span>

<span class="c1"># counting them down</span>

<span class="c1"># todo</span>
<span class="c1">#   -update gridit to use the new grid algorithm:</span>
<span class="c1">#       -OpenMolcas GridIt is not maintained, has different bugs across versions, and worst is slow for our purposes</span>
<span class="c1">#         Class for orbitals defined in term of basis functions, which can be computed</span>
<span class="c1">#         at arbitrary points in space.</span>
<span class="c1">#         The basis functions and orbitals can be read from HDF5 and Molden formats.</span>
<span class="c1">#         Orbital coefficients can be read from InpOrb format if an HDF5 file has been</span>
<span class="c1">#         read before.</span>
<span class="c1">#       -Use the better grids for improved results and a lower computational cost</span>
<span class="c1">#       -Improve analysis to see better the information at the peaks</span>
<span class="c1">#   -Code Review for Lindblad Equation and Becke Weights</span>
<span class="c1">#   -modularize the fortran codebase for Lindblad Equation and Becke Weights</span>
<span class="c1">#   -Instead of using the second pulse as timedelay we should use the last pulse since that would be the probe</span>
<span class="c1">#   -update for C_i optimization and reconstruction</span>
<span class="c1">#   -add parameter search for multiple runs with different settings optimizing use of resources, time, and visualization</span>
<span class="c1">#   -Plot per polarization images too for a better breakdown of the data</span>
<span class="c1"># fixme most of the data is gotten from RASSCF H5 file only, but I believe we are looking for the integrals, RASSI?</span>
<span class="c1">#   -fix manipulation of Atomic Charges as they require a flipped sign or rotation of matrix e.g. [::-1] to correctly</span>
<span class="c1">#       match the dipole</span>
<span class="c1">#   -implement more  validation checks of settings between runs, between modules, and between configurations of</span>
<span class="c1">#       different programs like molcas etc...</span>
<span class="c1">#   -update python documentation and add more tests</span>
<span class="c1">#   -granularity to what plots to plot</span>
<span class="c1">#</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Ruben Fernandez Carbon.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>